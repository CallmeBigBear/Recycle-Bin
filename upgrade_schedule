#!/bin/bash
# Automate Kopi Upgrade by NodesVault

if [ $1 -eq 0 ]; then
    echo "ERROR: Enter new version | e.g. v14"
    exit 1
else
    BINARY_LINK="https://github.com/kopi-money/kopi/releases/download/$1/kopid-$1-linux-amd64"
    DEST_HEIGHT=$2

fi

#Install jq
if command -v jq &> /dev/null; then
    echo "jq INSTALLED"
else
    echo "INSTALLING jq..."
    apt update && apt install jq -y
fi

wget -O kopid $BINARY_LINK && chmod +x kopid
rpc_port=$(grep -m 1 -oP '^laddr = "\K[^"]+' "$HOME/.kopid/config/config.toml" | cut -d ':' -f 3)
BINARY_LOCATION=$(which kopid)
echo "OLD VERSION:"
kopid version
echo "NEW VERSION:"
./kopid version

printf "\033[91mHEIGHT TO UPGRADE: $destheight \033[0m"

while :
do
  currentheight=$(curl -s localhost:$rpc_port/status | jq -r .result.sync_info.latest_block_height)
  [ $currentheight -ge $destheight ] && mv kopid $BINARY_LOCATION && systemctl restart kopid && echo "UPGRADED!!!" && break
    echo Block left: $((destheight - currentheight))
  sleep 15
done
